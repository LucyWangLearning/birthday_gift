<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»™å¼ æŒ¯å®‡çš„ç”Ÿæ—¥ç¤¼ç‰©</title>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
      font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
      color: #4b2067;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin-top: 30px;
      font-size: 2.5em;
      color: #7c3aed;
      text-shadow: 2px 2px 8px #fff6;
      text-align: center;
    }
    #map {
      width: 90vw;
      height: 60vw;
      max-height: 700px;
      margin: 30px auto 0 auto;
      border-radius: 30px;
      box-shadow: 0 8px 32px #7c3aed44;
      overflow: hidden;
      position: relative;
      background: #e0c3fc;
    }
    .star {
      position: absolute;
      width: 36px;
      height: 36px;
      pointer-events: none;
      z-index: 10;
    }
    .tip {
      background: #fff6;
      color: #7c3aed;
      border-radius: 16px;
      padding: 10px 20px;
      font-size: 1.2em;
      margin-top: 10px;
      box-shadow: 0 2px 8px #7c3aed22;
      display: inline-block;
      text-align: center;
      max-width: 90vw;
    }
    .leaflet-container {
      background: transparent !important;
      border-radius: 30px;
    }
    .leaflet-popup-content-wrapper {
      background: #f3e8ff;
      color: #7c3aed;
      border-radius: 16px;
      font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
    }
    .leaflet-popup-tip {
      background: #f3e8ff;
    }
    .leaflet-control-zoom {
      display: none;
    }
    .star-marker { animation: star-bounce 0.7s cubic-bezier(.68,-0.55,.27,1.55); }
    @keyframes star-bounce {
      0% { transform: scale(0.2); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      80% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    .star-svg { filter: drop-shadow(0 2px 6px #ffecb3); }
    .custom-marker { /* ä¸è¦åŠ animationï¼Œé¿å…å½±å“å®šä½ */ }
    @keyframes marker-flip {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(-1); }
    }
    .marker-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      box-shadow: 0 2px 8px #b39ddb88;
      /* ä¸å†ç”¨animation */
      transition: transform 0.18s cubic-bezier(.68,-0.55,.27,1.55);
    }
    body.marker-anim-sync .marker-img {
      animation-delay: 0s !important;
      animation-play-state: running;
    }
    @media (max-width: 600px) {
      h1, .tip {
        text-align: center !important;
        display: block !important;
        margin-left: auto;
        margin-right: auto;
      }
      .tip {
        font-size: 1.1em;
      }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h1>å·å„¿ç»™å¼ æŒ¯å®‡çš„ç”Ÿæ—¥ç¤¼ç‰©çš„ä¸€éƒ¨åˆ†</h1>
  <div id="map"></div>
  <div class="tip" id="tip">ä½ å°±ç‚¹ç€ç©å„¿å§ï¼Œè¿™ä¸ªpageå¯èƒ½ä¼šæ›´æ–°å§â€¦â€¦</div>
  <div id="celebrate-modal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:9999;background:rgba(80,40,120,0.18);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;">
    <div style="background:rgba(255,255,255,0.98);border-radius:32px;box-shadow:0 8px 32px #7c3aed44;padding:36px 32px 24px 32px;min-width:260px;max-width:90vw;text-align:center;position:relative;">
      <div style="font-size:2.5em;">ğŸ‰ğŸ‚ğŸ¥³ğŸˆâœ¨</div>
      <div style="font-size:1.3em;margin:18px 0 24px 0;color:#7c3aed;">ç¥ä½ ç”Ÿæ—¥å¿«ä¹é¸­ï¼Œè¦ä¸è¦å†ç©å„¿ä¸€æ¬¡ï¼Ÿ</div>
      <button id="restart-btn" style="background:linear-gradient(90deg,#a18cd1,#fbc2eb);color:#fff;font-size:1.1em;padding:10px 36px;border:none;border-radius:20px;box-shadow:0 2px 8px #7c3aed22;cursor:pointer;">å†æ¥ä¸€æ¬¡</button>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // åœ°ç‚¹æ•°æ®
    const locations = [
      { name: 'æˆéƒ½', lat: 30.5728, lng: 104.0668, zoom: 7, area: 1.2 },
      { name: 'æ­å·', lat: 30.2741, lng: 120.1551, zoom: 7, area: 1.2 },
      { name: 'æ–°åŠ å¡', lat: 1.3521, lng: 103.8198, zoom: 9, area: 0.5 },
      { name: 'å¤å¨å¤·', lat: 21.3069, lng: -157.8583, zoom: 8, area: 1.0 },
      { name: 'éŸ©å›½', lat: 37.5665, lng: 126.9780, zoom: 7, area: 1.0 }, // é¦–å°”
      { name: 'ç™½ä¿„ç½—æ–¯', lat: 53.9006, lng: 27.5590, zoom: 6, area: 2.5 }, // æ˜æ–¯å…‹
      { name: 'å¾·å›½', lat: 51.1657, lng: 10.4515, zoom: 5, area: 2.5 },
    ];
    let step = 0; // å½“å‰æ­¥éª¤ï¼Œåˆå§‹ä¸º0ï¼Œç¬¬ä¸€æ­¥åˆ¤å®šæˆéƒ½
    let stars = [];
    let guessedLatLngs = [];
    let polyline = null;

    // åˆå§‹åŒ–åœ°å›¾ï¼Œæ˜¾ç¤ºæˆéƒ½å’Œæ­å·
    const map = L.map('map', {
      center: [30.4, 112],
      zoom: 5,
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 10,
      maxBounds: [[-85, -180], [85, 180]],
      dragging: false, // åˆå§‹ç¦æ­¢æ‹–åŠ¨
      scrollWheelZoom: false, // åˆå§‹ç¦æ­¢æ»šè½®ç¼©æ”¾
      doubleClickZoom: false, // åˆå§‹ç¦æ­¢åŒå‡»ç¼©æ”¾
      boxZoom: false, // åˆå§‹ç¦æ­¢æ¡†é€‰ç¼©æ”¾
      keyboard: false // åˆå§‹ç¦æ­¢é”®ç›˜ç¼©æ”¾
    });
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      minZoom: 2,
      maxZoom: 19,
    }).addTo(map);

    // marker.jpgå›¾ç‰‡Leaflet markerå›¾æ ‡ï¼ˆåŒæ­¥åŠ¨ç”»ï¼‰
    const markerIcon = L.divIcon({
      className: 'custom-marker',
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      html: `<img src="marker.jpg" class="marker-img" width="32" height="32" draggable="false"/>`
    });

    // æ˜¾ç¤ºmarkerå›¾ç‰‡
    function showStar(lat, lng) {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‚¹çš„marker
      if (stars.some(s => s.lat === lat && s.lng === lng)) return;
      const marker = L.marker([lat, lng], { icon: markerIcon, interactive: false, keyboard: false, zIndexOffset: 1000 }).addTo(map);
      stars.push({ marker, lat, lng });
    }

    // è¿çº¿
    function updatePolyline() {
      if (polyline) {
        map.removeLayer(polyline);
      }
      if (guessedLatLngs.length > 1) {
        polyline = L.polyline(guessedLatLngs, { color: '#FFD600', weight: 4, dashArray: '6 8', lineCap: 'round' }).addTo(map);
      }
    }

    // æ­¥éª¤æç¤º
    function setTip(text) {
      document.getElementById('tip').innerText = 'ä½ å°±ç‚¹ç€ç©å„¿å§ï¼Œè¿™ä¸ªpageå¯èƒ½ä¼šæ›´æ–°å§â€¦â€¦';
    }

    // åˆ¤å®šåŒºåŸŸ
    function isInArea(lat, lng, target, area) {
      // æ–°åŠ å¡ç‰¹æ®Šåˆ¤å®šï¼šæ–°åŠ å¡æˆ–é©¬æ¥è¥¿äºšéƒ½ç®—
      if (target.name === 'æ–°åŠ å¡') {
        // æ–°åŠ å¡å¤§è‡´èŒƒå›´
        const sgBounds = {
          north: 1.48, south: 1.20, west: 103.6, east: 104.1
        };
        // é©¬æ¥è¥¿äºšå¤§è‡´èŒƒå›´
        const myBounds = {
          north: 7.5, south: 0.8, west: 99.6, east: 119.3
        };
        if (
          lat >= sgBounds.south && lat <= sgBounds.north &&
          lng >= sgBounds.west && lng <= sgBounds.east
        ) return true;
        if (
          lat >= myBounds.south && lat <= myBounds.north &&
          lng >= myBounds.west && lng <= myBounds.east
        ) return true;
      }
      // éŸ©å›½ç‰¹æ®Šåˆ¤å®šï¼šæ•´ä¸ªéŸ©å›½åŒºåŸŸéƒ½ç®—
      if (target.name === 'éŸ©å›½') {
        // éŸ©å›½å¤§è‡´èŒƒå›´
        const krBounds = {
          north: 38.7, south: 33.0, west: 124.5, east: 131.9
        };
        if (
          lat >= krBounds.south && lat <= krBounds.north &&
          lng >= krBounds.west && lng <= krBounds.east
        ) return true;
      }
      // å¤å¨å¤·ç‰¹æ®Šåˆ¤å®šï¼šå››å¤§å²›éƒ½ç®—
      if (target.name === 'å¤å¨å¤·') {
        // å››å¤§å²›ç»çº¬åº¦èŒƒå›´ï¼ˆå¤§è‡´ï¼‰
        const islands = [
          // æ¬§èƒ¡å²›
          { north: 21.72, south: 21.20, west: -158.3, east: -157.6 },
          // æ¯›ä¼Šå²›
          { north: 21.05, south: 20.60, west: -156.8, east: -156.2 },
          // å¤å¨å¤·å¤§å²›
          { north: 20.30, south: 18.80, west: -156.1, east: -154.7 },
          // è€ƒè‰¾å²›
          { north: 22.30, south: 21.80, west: -159.8, east: -159.3 },
        ];
        for (const isl of islands) {
          if (
            lat >= isl.south && lat <= isl.north &&
            lng >= isl.west && lng <= isl.east
          ) return true;
        }
      }
      // å…¶ä»–åœ°ç‚¹æŒ‰åŸæœ‰é€»è¾‘
      const R = 6371; // åœ°çƒåŠå¾„km
      const dLat = (lat - target.lat) * Math.PI / 180;
      const dLng = (lng - target.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat * Math.PI / 180) * Math.cos(target.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c;
      // åˆ¤å®šèŒƒå›´éšæ­¥æ•°é€’å¢å˜å¤§
      return d < area * (1 + step * 0.8) * 50;
    }

    // æ­¥éª¤æµç¨‹
    function nextStep() {
      if (step < locations.length) {
        const points = locations.slice(0, step + 1).map(loc => [loc.lat, loc.lng]);
        let bounds = L.latLngBounds(points);
        let duration = 2.2; // ç»Ÿä¸€è°ƒæ…¢
        if (step === 1) {
          const pad = 4;
          bounds = L.latLngBounds([
            [Math.min(points[0][0], points[1][0]) - pad, Math.min(points[0][1], points[1][1]) - pad],
            [Math.max(points[0][0], points[1][0]) + pad, Math.max(points[0][1], points[1][1]) + pad]
          ]);
        }
        map.fitBounds(bounds, { animate: true, padding: [140, 140], duration });
        map.once('moveend', () => {
          setTimeout(() => {
            updatePolyline();
          }, 400);
        });
        setTimeout(() => {
          setTip(`è¯·ç‚¹å‡»"${locations[step].name}"æ‰€åœ¨åŒºåŸŸï¼`);
        }, 800);
      } else {
        setTip();
        map.fitBounds([[-60, -170], [75, 180]], { animate: true, padding: [30, 30], duration: 2.2 });
        map.once('moveend', () => {
          setTimeout(() => {
            updatePolyline();
            // æ˜¾ç¤ºåº†ç¥å¼¹çª—
            document.getElementById('celebrate-modal').style.display = 'flex';
          }, 400);
        });
      }
    }

    // åˆå§‹ç¼©æ”¾åˆ°æˆéƒ½åŒºåŸŸ
    // ç”¨æˆéƒ½ä¸ºä¸­å¿ƒæ˜¾ç¤ºå‘¨è¾¹
    map.setView([locations[0].lat, locations[0].lng], 8); // æˆéƒ½å‘¨è¾¹
    setTimeout(() => {
      setTip();
    }, 800);

    // é‡ç½®æ¸¸æˆçŠ¶æ€
    function resetGame() {
      // ç§»é™¤æ‰€æœ‰marker
      stars.forEach(({ marker }) => marker.remove());
      stars = [];
      // ç§»é™¤è¿çº¿
      if (polyline) { map.removeLayer(polyline); polyline = null; }
      guessedLatLngs = [];
      step = 0;
      // æ¢å¤åœ°å›¾åˆ°æˆéƒ½å‘¨è¾¹
      map.setView([locations[0].lat, locations[0].lng], 8);
      setTip();
      // ç¦æ­¢ç¼©æ”¾æ‹–åŠ¨
      map.dragging.disable();
      map.scrollWheelZoom.disable();
      map.doubleClickZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      // éšè—å¼¹çª—
      document.getElementById('celebrate-modal').style.display = 'none';
    }

    // ç‚¹å‡»äº‹ä»¶
    map.on('click', function(e) {
      if (step >= locations.length) return;
      const loc = locations[step];
      if (isInArea(e.latlng.lat, e.latlng.lng, loc, loc.area)) {
        showStar(loc.lat, loc.lng);
        guessedLatLngs.push([loc.lat, loc.lng]);
        updatePolyline(); // ç«‹å³æ˜¾ç¤ºè¿çº¿
        // ç‚¹å‡»æˆéƒ½åæ¢å¤åœ°å›¾ç¼©æ”¾å’Œæ‹–åŠ¨
        if (step === 0) {
          map.options.dragging = true;
          map.options.scrollWheelZoom = true;
          map.options.doubleClickZoom = true;
          map.options.boxZoom = true;
          map.options.keyboard = true;
          map.dragging.enable();
          map.scrollWheelZoom.enable();
          map.doubleClickZoom.enable();
          map.boxZoom.enable();
          map.keyboard.enable();
        }
        step++;
        nextStep();
      } else {
        alert('ç‚¹é”™å•¦ï¼è¯·å†è¯•ä¸€æ¬¡~');
      }
    });

    // é¡µé¢åŠ è½½åç”¨JSå®šæ—¶å™¨åŒæ­¥æ‰€æœ‰marker-imgçš„transformï¼Œå®ç°å·¦å³ç¿»è½¬åŠ¨ç”»
    function syncMarkerFlip() {
      let flipped = false;
      setInterval(() => {
        flipped = !flipped;
        document.querySelectorAll('.marker-img').forEach(img => {
          img.style.transform = flipped ? 'scaleX(-1)' : 'scaleX(1)';
        });
      }, 500);
    }
    document.addEventListener('DOMContentLoaded', syncMarkerFlip);

    // ç»‘å®š"å†æ¥ä¸€æ¬¡"æŒ‰é’®
    document.getElementById('restart-btn').onclick = resetGame;

    // é¡µé¢åˆå§‹æ—¶ç¡®ä¿å¼¹çª—éšè—
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('celebrate-modal').style.display = 'none';
    });
  </script>
</body>
</html> 
